<!DOCTYPE html>
<html lang="hr" class="h-100" xmlns:th="https://thymeleaf.org">

<head th:replace="fragments/general :: head"></head>
<link href="../static/css/checkout.css" th:href="@{/css/checkout.css}" rel="stylesheet" />

<head>
</head>

<body>
<header th:replace="fragments/general :: header"></header>

<div class="container mt-5 p-3 rounded cart">
    <div class="row no-gutters" style="margin-top: 20px;">
        <div class="col-md-8">
            <div class="product-details mr-2">
                <div class="d-flex flex-row align-items-center">
                    <a href="#" onclick="location.href = document.referrer; return false;">
                        <i class="fa fa-long-arrow-left"></i>
                        <span class="ml-2">Nazad na restoran</span>
                    </a>
                </div>
                <hr>
                <h6 class="mb-0">Košarica</h6>

                <th:block th:each="item: ${foodItems}">
                    <div class="d-flex justify-content-between align-items-center mt-3 p-2 items rounded">
                        <div class="d-flex flex-row">
                            <img class="checkout-item-image" th:src="${item.getImage()}" src ="${item.getImage()}" alt="" width="40">
                            <div class="ml-2">
                                <span class="font-weight-bold d-block">[[${item.getName()}]]  ([[${item.getQuantity()}]] x [[${item.getPortion().getName().getName()}]])</span> <!----CHANGED> <!-->
                                <th:block th:each="condiment: ${item.getCondiments()}"><!----CHANGED> <!-->
                                    <span class="spec" style="font-size: 13px;">+[[${condiment.getName().getName()}]]</span><br>
                                </th:block>

                                <br><span class="spec checkout-item-price" style="font-size: inherit;font-weight: bolder;">[[${item.getPrice()}]]KM</span><!----CHANGED> <!-->

                            </div>
                        </div>
                    </div>
                </th:block>
                <div class="d-flex justify-content-between align-items-center mt-3 p-2 items rounded">
                    <div class="d-flex flex-row">
                        <div class="ml-2">
                            <span class="font-weight-bold d-block">TOTAL</span>
                        </div>
                    </div>
                    <div class="d-flex flex-row align-items-center">
                        <span class="d-block ml-5 font-weight-bold">[[${total}]]KM</span></div>
                </div>

            </div>
        </div>
        <div class="col-md-4">
            <div class="payment-info">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Detalji dostave</span>
                </div>
                <div>
                    <label class="credit-card-label">Adresa dostave</label>
                    <input id="autocomplete" placeholder="Unesite svoju lokaciju" type="text" class="form-control credit-inputs">
                </div>
                <div>
                    <label class="credit-card-label">Dodatne informacija za dostavu</label>
                    <input type="text"
                           id="delivery_note"
                           value="deliv note"
                           placeholder="Npr. drugi kat zgrade stan X, ili detaljnije objašnjenje vaše adrese ukoliko je potrebno"
                           class="form-control credit-inputs">
                </div>
                <div>
                    <label class="credit-card-label">Broj telefona</label>
                    <input type="text"
                           id="phone"
                           value="061234568"
                           placeholder="Unesite broj telefona"
                           class="form-control credit-inputs">
                </div>
                <div>
                    <label class="credit-card-label">Napomena</label>
                    <textarea rows="2"
                              id="restaurant_note"
                              class="form-control credit-inputs"
                              placeholder="Npr. trebaju mi vilica i nož">Rest note</textarea>
                </div>

                <hr class="line">
                <div class="d-flex justify-content-between information">
                    <span>UKUPNO</span>
                    <span>[[${total}]]KM</span>
                </div>
                <button onclick="sendOrder()" class="btn btn-primary btn-block d-flex justify-content-between mt-3" type="button" style="background-color: #1e7e34">
                    <span>[[${total}]]KM</span>
                    <span>NARUČI
            <i class="fa fa-long-arrow-right ml-1"></i>
          </span>
                </button>
            </div>
        </div>
    </div>
</div>



<footer th:replace="fragments/general :: footer">
</footer>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous">
</script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
</script>

<script th:inline="javascript">

    let foodItemsVar = [[${foodItems}]];
    let restaurantId = [[${restaurantId}]];

    function sendOrder(){

        let deliveryNote = $("#delivery_note").val().trim();
        let restaurantNote = $("#restaurant_note").val().trim();
        let phone = $("#phone").val().trim();
        let orderRequest = {
            foodItems : foodItemsVar,
            deliveryNote : deliveryNote,
            restaurantNote : restaurantNote,
            phone : phone
        };

        let csrf_header = document.querySelector('meta[name="_csrf_header"]').content;
        let csrf = document.querySelector('meta[name="_csrf"]').content;

        $.ajax({
            url:`/narudzba/new/${restaurantId}`,
            method:'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                [csrf_header] : csrf
            },
            data: JSON.stringify(orderRequest),
            success: function(data) {
                if(data.status === "success"){
                    localStorage.removeItem("mezi_cart_restaurant_"+restaurantId);
                    window.location.href =  window.location.protocol + "//" + window.location.host + data.path;// redirects user to the progress page tied to his order
                    //alert("done")
                }else{
                    alert("Error !");
                }
            },
            error: function(request, status, error) {
                alert("The request failed");
            }
        });

    }



</script>
</body>

</html>
